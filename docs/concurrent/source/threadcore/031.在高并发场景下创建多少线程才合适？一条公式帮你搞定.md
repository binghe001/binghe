## 高并发场景下创建多少线程才合适？一条公式帮你搞定！！

创建多少线程合适， 要看多线程具体的应用场景。 一般来说，我们可以将程序分为：<font color="#FF0000">**CPU密集型程序和I/O密集型程序**</font>， 而针对于CPU密集型程序和I/O密集型程序，其计算最佳线程数的方法是不同的 。

## CPU密集型程序

对于CPU密集型计算， 多线程本质上是提升多核CPU的利用率， 所以对于一个4核的CPU， 每个核一个线程， 理论上创建4个线程就可以了， 再多创建线程也只是增加线程切换的成本。 所以， 对于CPU密集型的计算场景， 理论上“线程的量=CPU核数”就是最合适的。 但是在实际工作中， 一般会将线程数量设置为“CPU核数+1”， 这样的话， 当线程因为偶尔的内存页失效或其他原因导致阻塞时， 这个额外的线程可以顶上， 从而保证CPU的利用率 。

<font color="#FF0000">**所以，在CPU密集型的程序中，一般可以将线程数设置为CPU核数+1。**</font>

## I/O密集型程序

对于I/O密集型的程序，最佳的线程数是与程序中CPU计算和I/O操作的耗时比相关。总体来说，可以将其总结为如下的公式。

### 单核CPU

<font color="#FF0000">**最佳线程数 = 1 +（I/O耗时 / CPU耗时）**  </font>

我们令R=I/O耗时 / CPU耗时， 可以这样理解： 当线程A执行IO操作时， 另外R个线程正好执行完各自的CPU计算。 这样CPU的利用率就达到了100%。  

### 多核CPU

多核CPU的最佳线程数在单核CPU最佳线程数的基础上，乘以CPU核数即可，如下所示。

<font color="#FF0000">**最佳线程数=CPU核数 * [ 1 +（I/O耗时 / CPU耗时） ]**  </font>

## 总结

上述公式计算的结果为最佳理论值，实际工作中还是要通过实际压测数据来找到最佳线程数，将硬件的性能发挥到极致。  


## 写在最后

> 如果你觉得冰河写的还不错，请微信搜索并关注「 **冰河技术** 」微信公众号，跟冰河学习高并发、分布式、微服务、大数据、互联网和云原生技术，「 **冰河技术** 」微信公众号更新了大量技术专题，每一篇技术文章干货满满！不少读者已经通过阅读「 **冰河技术** 」微信公众号文章，吊打面试官，成功跳槽到大厂；也有不少读者实现了技术上的飞跃，成为公司的技术骨干！如果你也想像他们一样提升自己的能力，实现技术能力的飞跃，进大厂，升职加薪，那就关注「 **冰河技术** 」微信公众号吧，每天更新超硬核技术干货，让你对如何提升技术能力不再迷茫！


![](https://img-blog.csdnimg.cn/20200906013715889.png)
