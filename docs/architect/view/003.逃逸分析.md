## 逃逸分析，yyds！！

**大家好，我是冰河~~**

在JVM的实现中，为了提高JVM的性能和节省内存空间，JVM提供了一种叫做“逃逸分析”的特性，而且对于“逃逸分析”这种特性，也是近年来大厂面试常问的知识点。今天，我们就一起来聊聊什么是逃逸分析。

## 逃逸分析的概念

先以官方的形式来说下什么是逃逸分析。逃逸分析就是：一种确定指针动态范围的静态分析，它可以分析在程序的哪些地方可以访问到指针。

在JVM的即时编译语境下，逃逸分析将判断新建的对象是否逃逸。即时编译判断对象是否逃逸的依据：一种是对象是否被存入堆中（静态字段或者堆中对象的实例字段），另一种就是对象是否被传入未知代码。

直接说这些概念，确实有点晕啊，那我们就来两个示例。

![](https://img-blog.csdnimg.cn/20200921233622197.jpg)


## 对象逃逸示例

**一种典型的对象逃逸就是：对象被复制给成员变量或者静态变量，可能被外部使用，此时变量就发生了逃逸。**

我们可以用下面的代码来表示这个现象。

```java
/**
 * @author binghe
 * @description 对象逃逸示例1
 */
public class ObjectEscape{
    private User user;
    public void init(){
        user = new User();
    }
}
```

在ObjectEscape类中，存在一个成员变量user，我们在init()方法中，创建了一个User类的对象，并将其赋值给成员变量user。此时，对象被复制给了成员变量，可能被外部使用，此时的变量就发生了逃逸。

**另一种典型的场景就是：对象通过return语句返回。如果对象通过return语句返回了，此时的程序并不能确定这个对象后续会不会被使用，外部的线程可以访问到这个变量，此时对象也发生了逃逸。**

我们可以用下面的代码来表示这个现象。

```java
/**
 * @author binghe
 * @description 对象逃逸示例2
 */
public class ObjectReturn{
    public User createUser(){
        User user = new User();
        return user;
    }
}
```

给出两个示例，相信小伙伴们对JVM的逃逸分析多少有点了解了吧，没错，JVM通过逃逸分析，能够分析出新对象的使用范围，从而决定新对象是否要在堆上进行分配。

![](https://img-blog.csdnimg.cn/20200921233635206.jpg)


还没完，我们继续看下逃逸分析的优点，以便于小伙伴们能够更好的理解逃逸分析。

## 逃逸分析的优点

逃逸分析的优点总体上来说可以分为三个：对象可能分配在栈上、分离对象或标量替换、消除同步锁。我们可以使用下图来表示。
![](https://img-blog.csdnimg.cn/20200921233655382.jpg)

### 对象可能分配在栈上

JVM通过逃逸分析，分析出新对象的使用范围，就可能将对象在栈上进行分配。栈分配可以快速地在栈帧上创建和销毁对象，不用再将对象分配到堆空间，可以有效地减少 JVM 垃圾回收的压力。

### 分离对象或标量替换

当JVM通过逃逸分析，确定要将对象分配到栈上时，即时编译可以将对象打散，将对象替换为一个个很小的局部变量，我们将这个打散的过程叫做标量替换。将对象替换为一个个局部变量后，就可以非常方便的在栈上进行分配了。

### 同步锁消除

如果JVM通过逃逸分析，发现一个对象只能从一个线程被访问到，则访问这个对象时，可以不加同步锁。如果程序中使用了synchronized锁，则JVM会将synchronized锁消除。

**这里，需要注意的是：这种情况针对的是synchronized锁，而对于Lock锁，则JVM并不能消除。**

要开启同步消除，需要加上 -XX:+EliminateLocks 参数。因为这个参数依赖逃逸分析，所以同时要打开 -XX:+DoEscapeAnalysis 选项。

**所以，并不是所有的对象和数组，都是在堆上进行分配的，由于即时编译的存在，如果JVM发现某些对象没有逃逸出方法，就很有可能被优化成在栈上分配。**

## 衍生出的面试题

其实，针对逃逸分析还会衍生出一些典型的面试题，例如：**Java中的对象一定是在堆上分配的吗？** 只要我们充分掌握了逃逸分析的原理，回答这种面试题就非常简单了。

### 关于面试题

**Java中的对象一定是在堆上分配的吗？**

面试官这样问，如果大家不了解逃逸分析的话，那肯定就有些小伙伴心里会想：我从一开始学习Java时，就知道了：Java中的对象是在堆上创建的，对象的引用是存储到栈中的，那Java中的对象是在堆上分配的啊！难道不是吗？

![](https://img-blog.csdnimg.cn/20200921233555767.jpg)


如果你这样回答，就会被直接Pass掉。

今天，我们介绍完什么是逃逸分析后，相信各位小伙伴就知道如何去完美的回答这道面试题了吧。

### 面试题解答思路

**总体思路上，你可以这样回答：Java中的对象不一定是在堆上分配的，因为JVM通过逃逸分析，能够分析出一个新对象的使用范围，并以此确定是否要将这个对象分配到堆上。**

## 总结

今天，我们一起学习了JVM的整体架构和调优参数，主要包括：JVM的总体结构、JVM的分类、JVM的构成和调优参数。你学会了吗？欢迎在文末留言说出你的想法，如果你有更好的见解，也可以在文末留言和大家交流。

## 写在最后

> 如果你觉得冰河写的还不错，请微信搜索并关注「 **冰河技术** 」微信公众号，跟冰河学习高并发、分布式、微服务、大数据、互联网和云原生技术，「 **冰河技术** 」微信公众号更新了大量技术专题，每一篇技术文章干货满满！不少读者已经通过阅读「 **冰河技术** 」微信公众号文章，吊打面试官，成功跳槽到大厂；也有不少读者实现了技术上的飞跃，成为公司的技术骨干！如果你也想像他们一样提升自己的能力，实现技术能力的飞跃，进大厂，升职加薪，那就关注「 **冰河技术** 」微信公众号吧，每天更新超硬核技术干货，让你对如何提升技术能力不再迷茫！


![](https://img-blog.csdnimg.cn/20200906013715889.png)